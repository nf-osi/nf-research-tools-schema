name: Mine PubMed for NF Publications

on:
  schedule:
    # Run weekly on Sundays at 9 AM UTC (before Monday's tool coverage workflow)
    - cron: '0 9 * * 0'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      max_results:
        description: 'Maximum number of publications to retrieve'
        required: false
        type: string
        default: '1000'
      years:
        description: 'Year range (e.g., 2020:2024) to limit search'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  mine-pubmed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests pandas python-dateutil

      - name: Mine PubMed for NF publications
        id: mining
        run: |
          echo "Mining PubMed for neurofibromatosis research articles..."

          # Build command with optional parameters
          CMD="python tool_coverage/scripts/mine_pubmed_nf.py"

          if [ -n "${{ github.event.inputs.max_results }}" ]; then
            CMD="$CMD --max-results ${{ github.event.inputs.max_results }}"
          fi

          if [ -n "${{ github.event.inputs.years }}" ]; then
            CMD="$CMD --years ${{ github.event.inputs.years }}"
          fi

          # Run mining
          echo "Running: $CMD"
          $CMD 2>&1 | tee mining_output.log

          # Check if output file was created
          if [ -f "tool_coverage/outputs/pubmed_nf_publications.csv" ]; then
            echo "mining_success=true" >> $GITHUB_OUTPUT

            # Count publications
            PUB_COUNT=$(tail -n +2 tool_coverage/outputs/pubmed_nf_publications.csv | wc -l)
            echo "pub_count=$PUB_COUNT" >> $GITHUB_OUTPUT
          else
            echo "mining_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate summary report
        if: steps.mining.outputs.mining_success == 'true'
        run: |
          cat > pr_body.md << 'EOF'
          # PubMed Mining Results - Neurofibromatosis Publications

          Mined PubMed for neurofibromatosis-related research articles with free full text.

          ## Results

          - **Publications found:** ${{ steps.mining.outputs.pub_count }}
          - **Criteria:** Journal articles (not reviews) with free full text available
          - **Search terms:** neurofibromatosis, NF1, NF2, schwannomatosis

          ## Next Steps

          1. **Review** publications for relevance
          2. **Merge PR** - Publications will be automatically upserted to Synapse table (syn26486839)
          3. **Classify** as tool usage (syn26486841) or development (syn26486807)
          4. **Run** publication mining workflow (#92) to discover tools

          ## Files

          - `tool_coverage/outputs/pubmed_nf_publications.csv` - Publications with metadata
          - `tool_coverage/outputs/pubmed_nf_publications_synapse.csv` - Synapse-ready format (auto-upserted on merge)

          Related to #97 (Step 1: Add NF-related publications from PubMed)

          ðŸ¤– Generated by automated PubMed mining workflow
          EOF

      - name: Upload results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pubmed-mining-results
          path: |
            tool_coverage/outputs/pubmed_nf_publications.csv
            tool_coverage/outputs/pubmed_nf_publications_synapse.csv
            mining_output.log
          retention-days: 90

      - name: Create Pull Request
        if: steps.mining.outputs.mining_success == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.NF_SERVICE_GIT_TOKEN }}
          commit-message: |
            Add PubMed mining results for NF publications

            - Mined ${{ steps.mining.outputs.pub_count }} neurofibromatosis publications
            - Filtered for research articles with free full text
            - Ready for review and Synapse upload
          branch: pubmed-mining-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ“š PubMed Mining Results - ${{ steps.mining.outputs.pub_count }} NF Publications'
          body-path: pr_body.md
          assignees: BelindaBGarana
          labels: |
            pubmed-mining
            publications
          add-paths: |
            tool_coverage/outputs/pubmed_nf_publications.csv
            tool_coverage/outputs/pubmed_nf_publications_synapse.csv
