name: Link Tool Datasets

on:
  workflow_run:
    workflows: ["Weekly Tool Annotation Review"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  link-datasets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run dataset linking script
        id: link
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          python scripts/link_tool_datasets.py
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "SUBMIT_tool_datasets.csv" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "CSV file created"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No CSV file created"
          fi

      - name: Upload CSV artifact
        if: steps.check_changes.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tool-datasets-submission
          path: SUBMIT_tool_datasets.csv
          retention-days: 30

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.NF_SERVICE_GIT_TOKEN }}
          commit-message: 'chore: link datasets to tool publications'
          title: 'Link Datasets to Tool Publications'
          assignees: BelindaBGarana
          body: |
            ## Automated Dataset Linking

            This PR adds dataset information to tool publications by:
            1. Finding publications linked to NF tools (via usage or development)
            2. Extracting studyId from those publications
            3. Querying Synapse for datasets associated with each study
            4. Creating a new `datasets` column in the tool publications table

            ### Data Sources
            - Publications: [syn16857542](https://www.synapse.org/Synapse:syn16857542)
            - Tool Usage: [syn26486841](https://www.synapse.org/Synapse:syn26486841)
            - Tool Development: [syn26486807](https://www.synapse.org/Synapse:syn26486807)
            - Target Table: [syn26486839](https://www.synapse.org/Synapse:syn26486839)

            ### What's Included
            - `SUBMIT_tool_datasets.csv`: CSV file ready for upsert to Synapse

            ---
            ðŸ¤– This PR was automatically generated by the [Link Tool Datasets workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          branch: link-tool-datasets-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            dataset-linking

      - name: Create workflow summary
        run: |
          if [ "${{ steps.check_changes.outputs.changes }}" = "true" ]; then
            echo "## Tool Dataset Linking Complete âœ“" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Run Date:** $(date)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- CSV file created: SUBMIT_tool_datasets.csv" >> $GITHUB_STEP_SUMMARY
            echo "- Pull request created for review" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR and CSV contents" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge the PR to trigger automatic upsert to Synapse" >> $GITHUB_STEP_SUMMARY
          else
            echo "## No Dataset Links Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The script ran but did not create any dataset links." >> $GITHUB_STEP_SUMMARY
          fi
