name: Upsert PubMed Publications to Synapse

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - 'tool_coverage/outputs/pubmed_nf_publications.csv'

permissions:
  contents: write
  issues: write

jobs:
  upsert-publications:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install synapseclient pandas

      - name: Upsert publications to Synapse
        id: upsert
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          python - <<'PYTHON_SCRIPT'
          import os
          import sys
          import pandas as pd
          import synapseclient
          from synapseclient import Table

          # Check if input file exists
          csv_file = 'tool_coverage/outputs/pubmed_nf_publications.csv'
          if not os.path.exists(csv_file):
              print(f"‚ùå File not found: {csv_file}")
              sys.exit(1)

          # Login to Synapse
          syn = synapseclient.Synapse()
          auth_token = os.getenv('SYNAPSE_AUTH_TOKEN')
          if not auth_token:
              print("‚ùå SYNAPSE_AUTH_TOKEN not found")
              sys.exit(1)

          syn.login(authToken=auth_token)
          print("‚úÖ Logged into Synapse")

          # Read publications
          df = pd.read_csv(csv_file)
          print(f"üìö Read {len(df)} publications from CSV")

          # Get existing publications to avoid duplicates
          print("üîç Checking for existing publications...")
          query = "SELECT pmid FROM syn26486839"
          existing = syn.tableQuery(query)
          existing_df = existing.asDataFrame()
          existing_pmids = set(existing_df['pmid'].str.upper().tolist())
          print(f"   Found {len(existing_pmids)} existing publications")

          # Filter out duplicates
          df['pmid_upper'] = df['pmid'].str.upper()
          new_pubs = df[~df['pmid_upper'].isin(existing_pmids)].copy()
          new_pubs = new_pubs.drop('pmid_upper', axis=1)

          if len(new_pubs) == 0:
              print("‚úÖ No new publications to add (all already exist)")
              # Write output for GitHub Actions
              with open(os.getenv('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f"new_count=0\n")
                  f.write(f"total_checked={len(df)}\n")
              sys.exit(0)

          print(f"üìù Adding {len(new_pubs)} new publications to syn26486839")

          # Add optional columns to dataframe (fill with empty string)
          optional_cols = ['fundingAgency', 'consortium']
          for col in optional_cols:
              if col not in new_pubs.columns:
                  new_pubs[col] = ''

          # Get table schema to validate columns
          print("üîç Checking table schema...")
          table_entity = syn.get('syn26486839')
          table_cols = syn.getTableColumns(table_entity)
          schema_col_names = {col.name for col in table_cols}
          print(f"   Table has {len(schema_col_names)} columns")

          # Prepare data for Synapse table
          # Note: We're not classifying as usage/development yet - that requires manual review
          # Only include columns that exist in both dataframe and table schema
          available_cols = ['pmid', 'doi', 'title', 'journal', 'year', 'pmc_id', 'publication_types'] + optional_cols
          valid_cols = [col for col in available_cols if col in new_pubs.columns and col in schema_col_names]

          print(f"   Using columns: {', '.join(valid_cols)}")
          table_df = new_pubs[valid_cols].copy()

          # Store to Synapse table
          table = syn.store(Table('syn26486839', table_df))
          print(f"‚úÖ Successfully added {len(new_pubs)} publications to syn26486839")

          # Create snapshot version for tracking
          print("   Creating snapshot version...")
          syn.create_snapshot_version('syn26486839')
          print("   ‚úÖ Snapshot version created")

          # Log the PMIDs that were added
          print("\nüìã Added PMIDs:")
          for pmid in table_df['pmid'].tolist()[:10]:  # Show first 10
              print(f"   - {pmid}")
          if len(table_df) > 10:
              print(f"   ... and {len(table_df) - 10} more")

          # Write output for GitHub Actions
          with open(os.getenv('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
              f.write(f"new_count={len(new_pubs)}\n")
              f.write(f"total_checked={len(df)}\n")

          PYTHON_SCRIPT

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const newCount = '${{ steps.upsert.outputs.new_count }}';
            const totalChecked = '${{ steps.upsert.outputs.total_checked }}';

            let message;
            if (newCount === '0') {
              message = `‚úÖ Publications checked - no new additions needed

            **Summary:**
            - Publications checked: ${totalChecked}
            - New publications added: 0 (all already exist in syn26486839)

            **Snapshot:** Table version snapshot created`;
            } else {
              message = `‚úÖ Publications successfully added to Synapse table syn26486839

            **Summary:**
            - Publications checked: ${totalChecked}
            - New publications added: ${newCount}
            - Synapse table: [syn26486839](https://www.synapse.org/Synapse:syn26486839)

            **Snapshot:** Table version snapshot created for tracking

            **Next Step:**
            Run tool mining workflow to discover tools and observations from these publications`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Comment on PR if failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå Failed to upsert publications to Synapse

            Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })
