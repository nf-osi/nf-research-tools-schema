name: Upsert PubMed Publications to Synapse

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - 'tool_coverage/outputs/pubmed_nf_publications.csv'
  workflow_dispatch:  # Allow manual testing
    inputs:
      dry_run:
        description: 'Dry run (test without upserting to Synapse)'
        required: false
        type: boolean
        default: true
      csv_path:
        description: 'Path to CSV file (default: tool_coverage/outputs/pubmed_nf_publications.csv)'
        required: false
        type: string
        default: 'tool_coverage/outputs/pubmed_nf_publications.csv'

permissions:
  contents: write
  issues: write

jobs:
  upsert-publications:
    # Run if: PR was merged OR manual workflow dispatch
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install synapseclient pandas

      - name: Upsert publications to Synapse
        id: upsert
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          CSV_PATH: ${{ github.event.inputs.csv_path || 'tool_coverage/outputs/pubmed_nf_publications.csv' }}
        run: |
          python - <<'PYTHON_SCRIPT'
          import os
          import sys
          import pandas as pd
          import synapseclient
          from synapseclient import Table

          # Try to import new API (synapseclient >= 4.9.0)
          try:
              from synapseclient.models import Table as TableModel
              USE_NEW_API = True
          except ImportError:
              USE_NEW_API = False

          # Get configuration from environment
          csv_file = os.getenv('CSV_PATH', 'tool_coverage/outputs/pubmed_nf_publications.csv')
          dry_run = os.getenv('DRY_RUN', 'false').lower() == 'true'

          if dry_run:
              print("=" * 80)
              print("ðŸ” DRY-RUN MODE - No changes will be made to Synapse")
              print("=" * 80)
              print()

          # Check if input file exists
          if not os.path.exists(csv_file):
              print(f"âŒ File not found: {csv_file}")
              sys.exit(1)

          # Login to Synapse
          syn = synapseclient.Synapse()
          auth_token = os.getenv('SYNAPSE_AUTH_TOKEN')
          if not auth_token:
              print("âŒ SYNAPSE_AUTH_TOKEN not found")
              sys.exit(1)

          syn.login(authToken=auth_token)
          print("âœ… Logged into Synapse")

          # Read publications
          df = pd.read_csv(csv_file)
          print(f"ðŸ“š Read {len(df)} publications from CSV")

          # Get existing publications to avoid duplicates
          print("ðŸ” Checking for existing publications...")

          if USE_NEW_API:
              # Use new API (synapseclient >= 4.9.0)
              table = TableModel(id='syn26486839')
              existing_df = table.query("SELECT pmid FROM syn26486839", synapse_client=syn)
          else:
              # Use old API (synapseclient < 4.9.0)
              query = "SELECT pmid FROM syn26486839"
              existing = syn.tableQuery(query)
              existing_df = existing.asDataFrame()

          if len(existing_df) > 0:
              existing_pmids = set(existing_df['pmid'].str.upper().tolist())
          else:
              existing_pmids = set()

          print(f"   Found {len(existing_pmids)} existing publications")

          # Filter out duplicates
          df['pmid_upper'] = df['pmid'].str.upper()
          new_pubs = df[~df['pmid_upper'].isin(existing_pmids)].copy()
          new_pubs = new_pubs.drop('pmid_upper', axis=1)

          if len(new_pubs) == 0:
              print("âœ… No new publications to add (all already exist)")
              # Write output for GitHub Actions
              with open(os.getenv('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f"new_count=0\n")
                  f.write(f"total_checked={len(df)}\n")
              sys.exit(0)

          print(f"ðŸ“ Adding {len(new_pubs)} new publications to syn26486839")

          # Add optional columns to dataframe (fill with empty string)
          optional_cols = ['fundingAgency', 'consortium']
          for col in optional_cols:
              if col not in new_pubs.columns:
                  new_pubs[col] = ''

          # Get table schema to validate columns
          print("ðŸ” Checking table schema...")

          if USE_NEW_API:
              # Use new API (synapseclient >= 4.9.0)
              table_model = TableModel(id='syn26486839')
              table_model = table_model.get(synapse_client=syn)

              # Extract column names - columns is a dict with column names as keys
              if isinstance(table_model.columns, dict):
                  schema_col_names = set(table_model.columns.keys())
              elif isinstance(table_model.columns, list):
                  schema_col_names = {col.name for col in table_model.columns}
              else:
                  schema_col_names = set()
          else:
              # Use old API (synapseclient < 4.9.0)
              table_entity = syn.get('syn26486839')
              table_cols = syn.getTableColumns(table_entity)
              schema_col_names = {col.name for col in table_cols}

          print(f"   Table has {len(schema_col_names)} columns")

          # Prepare data for Synapse table
          # Note: We're not classifying as usage/development yet - that requires manual review
          # Only include columns that exist in both dataframe and table schema
          available_cols = ['pmid', 'doi', 'title', 'journal', 'year', 'pmc_id', 'publication_types'] + optional_cols
          valid_cols = [col for col in available_cols if col in new_pubs.columns and col in schema_col_names]

          print(f"   Using columns: {', '.join(valid_cols)}")
          table_df = new_pubs[valid_cols].copy()

          if dry_run:
              # Dry-run mode - show what would be done
              print("\n" + "=" * 80)
              print("DRY-RUN: The following would be uploaded to syn26486839:")
              print("=" * 80)
              print(f"\nFirst 5 rows preview:")
              print(table_df.head().to_string())
              print(f"\nðŸ“Š Summary:")
              print(f"   Total rows to upload: {len(table_df)}")
              print(f"   Columns: {', '.join(table_df.columns.tolist())}")
              print("\nâœ… Dry-run validation complete - no changes made to Synapse")
          else:
              # Actual upsert
              table = syn.store(Table('syn26486839', table_df))
              print(f"âœ… Successfully added {len(new_pubs)} publications to syn26486839")

              # Create snapshot version for tracking
              print("   Creating snapshot version...")
              syn.create_snapshot_version('syn26486839')
              print("   âœ… Snapshot version created")

          # Log the PMIDs that were added
          print("\nðŸ“‹ Added PMIDs:")
          for pmid in table_df['pmid'].tolist()[:10]:  # Show first 10
              print(f"   - {pmid}")
          if len(table_df) > 10:
              print(f"   ... and {len(table_df) - 10} more")

          # Write output for GitHub Actions
          with open(os.getenv('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
              f.write(f"new_count={len(new_pubs)}\n")
              f.write(f"total_checked={len(df)}\n")
              f.write(f"dry_run={'true' if dry_run else 'false'}\n")

          PYTHON_SCRIPT

      - name: Comment on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const newCount = '${{ steps.upsert.outputs.new_count }}';
            const totalChecked = '${{ steps.upsert.outputs.total_checked }}';
            const dryRun = '${{ steps.upsert.outputs.dry_run }}' === 'true';

            let message;
            if (newCount === '0') {
              message = `âœ… Publications checked - no new additions needed

            **Summary:**
            - Publications checked: ${totalChecked}
            - New publications added: 0 (all already exist in syn26486839)

            **Snapshot:** Table version snapshot created`;
            } else {
              message = `âœ… Publications successfully added to Synapse table syn26486839

            **Summary:**
            - Publications checked: ${totalChecked}
            - New publications added: ${newCount}
            - Synapse table: [syn26486839](https://www.synapse.org/Synapse:syn26486839)

            **Snapshot:** Table version snapshot created for tracking

            **Next Step:**
            Run tool mining workflow to discover tools and observations from these publications`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Comment on PR if failed
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ Failed to upsert publications to Synapse

            Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            })

      - name: Create workflow summary
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "## PubMed Publications Upsert" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.upsert.outputs.dry_run }}" = "true" ]; then
            echo "### ðŸ” Dry-Run Mode" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Validation complete (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Upsert Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Successfully uploaded to Synapse" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:**" >> $GITHUB_STEP_SUMMARY
          echo "- CSV file: \`${{ env.CSV_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Publications checked: ${{ steps.upsert.outputs.total_checked }}" >> $GITHUB_STEP_SUMMARY
          echo "- New publications: ${{ steps.upsert.outputs.new_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.upsert.outputs.dry_run }}" != "true" ]; then
            echo "**Synapse Table:** [syn26486839](https://www.synapse.org/Synapse:syn26486839)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Snapshot:** Table version snapshot created" >> $GITHUB_STEP_SUMMARY
          fi
