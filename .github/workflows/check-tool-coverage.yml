name: Check Tool Coverage and Suggest Novel Tools

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      ai_validation:
        description: 'Run AI validation on mined tools using Goose'
        required: false
        type: boolean
        default: true
      max_publications:
        description: 'Maximum number of publications to mine (blank = all)'
        required: false
        type: string
        default: ''
      force_rereviews:
        description: 'Force re-review of already-reviewed publications'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

jobs:
  analyze-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r tool_coverage/requirements.txt

      - name: Check for ANTHROPIC_API_KEY
        id: check_api_key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "api_key_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… ANTHROPIC_API_KEY is configured"
          else
            echo "api_key_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  ANTHROPIC_API_KEY not found - AI validation will be skipped"
          fi

      - name: Install Goose CLI
        if: ${{ github.event.inputs.ai_validation != 'false' && steps.check_api_key.outputs.api_key_exists == 'true' }}
        run: |
          echo "Installing Goose CLI for AI validation..."
          # Install Go if needed
          sudo apt-get update
          sudo apt-get install -y golang-go
          # Install Goose
          go install github.com/block/goose@latest
          # Add to PATH
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Configure Goose
        if: ${{ github.event.inputs.ai_validation != 'false' && steps.check_api_key.outputs.api_key_exists == 'true' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Configuring Goose with Anthropic API..."
          # Goose will use ANTHROPIC_API_KEY from environment

      - name: Analyze GFF tool coverage
        id: coverage
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          echo "Running coverage analysis..."
          python tool_coverage/scripts/analyze_missing_tools.py 2>&1 | tee coverage_output.log

          # Extract key metrics for issue summary
          echo "coverage_complete=true" >> $GITHUB_OUTPUT

      - name: Mine publications for novel tools
        id: mining
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Mining publications for novel tools..."

          # Build command with optional flags
          CMD="python tool_coverage/scripts/fetch_fulltext_and_mine.py"

          # Add max publications limit if specified
          if [ -n "${{ github.event.inputs.max_publications }}" ]; then
            CMD="$CMD --max-publications ${{ github.event.inputs.max_publications }}"
          fi

          # Disable AI validation if requested or if API key is missing
          if [ "${{ github.event.inputs.ai_validation }}" = "false" ]; then
            CMD="$CMD --no-validate"
            echo "âš ï¸  AI validation disabled by user"
          elif [ "${{ steps.check_api_key.outputs.api_key_exists }}" != "true" ]; then
            CMD="$CMD --no-validate"
            echo "âš ï¸  AI validation disabled - ANTHROPIC_API_KEY not found"
          else
            echo "âœ… AI validation enabled"
          fi

          # Run mining
          echo "Running: $CMD"
          $CMD 2>&1 | tee mining_output.log || echo "mining_failed=true" >> $GITHUB_OUTPUT

          echo "mining_complete=true" >> $GITHUB_OUTPUT

      - name: Format mining results for submission
        id: formatting
        run: |
          echo "Formatting mining results into submission CSVs..."
          if [ -f "novel_tools_FULLTEXT_mining.csv" ]; then
            python tool_coverage/scripts/format_mining_for_submission.py 2>&1 | tee formatting_output.log
            echo "formatting_complete=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Skipping formatting - no mining results found"
          fi

      - name: Generate summary report
        id: summary
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          python tool_coverage/scripts/generate_coverage_summary.py > issue_body.md

          # Read the summary for the issue
          echo "ISSUE_BODY<<EOF" >> $GITHUB_OUTPUT
          cat issue_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tool-coverage-reports
          path: |
            GFF_Tool_Coverage_Report.pdf
            gff_publications_MISSING_tools.csv
            novel_tools_FULLTEXT_mining.csv
            priority_publications_FULLTEXT.csv
            GFF_publications_with_tools_FULLTEXT.csv
            SUBMIT_*.csv
            VALIDATED_*.csv
            tool_reviews/validation_report.xlsx
            tool_reviews/validation_summary.json
            tool_reviews/results/*.yaml
            coverage_output.log
            mining_output.log
            formatting_output.log
          retention-days: 90

      - name: Create or update GitHub issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.NF_SERVICE_GIT_TOKEN }}
          script: |
            const fs = require('fs');
            const issueBody = fs.readFileSync('issue_body.md', 'utf8');

            // Check for existing open issue with this title
            const issueTitle = 'ðŸ” Weekly Tool Coverage Report';
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated-report',
              per_page: 100
            });

            const existingIssue = issues.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ“Š Updated Report - ${new Date().toISOString().split('T')[0]}\n\n${issueBody}`
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['automated-report', 'tool-coverage']
              });
              console.log(`Created issue #${newIssue.number}`);
            }
