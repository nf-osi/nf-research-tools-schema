name: Check Tool Coverage and Suggest Novel Tools

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering
    inputs:
      ai_validation:
        description: 'Run AI validation on mined tools using Goose'
        required: false
        type: boolean
        default: true
      max_publications:
        description: 'Maximum number of publications to mine (blank = all)'
        required: false
        type: string
        default: ''
      force_rereviews:
        description: 'Force re-review of already-reviewed publications'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

# Cancel previous runs if a new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-coverage:
    runs-on: ubuntu-latest
    # Only run if: (1) manual trigger, OR (2) PR was merged from annotation review workflow
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'automated-annotation-review'))

    env:
      ENABLE_AI_VALIDATION: ${{ github.event.inputs.ai_validation != 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r tool_coverage/requirements.txt

      - name: Check for ANTHROPIC_API_KEY
        id: check_api_key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "api_key_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ ANTHROPIC_API_KEY is configured"
          else
            echo "api_key_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  ANTHROPIC_API_KEY not found - AI validation will be skipped"
          fi

      - name: Cache Goose CLI
        if: steps.check_api_key.outputs.api_key_exists == 'true'
        id: cache-goose
        uses: actions/cache@v4
        with:
          path: ~/goose-bin
          key: goose-1.23.2-linux-x86_64

      - name: Install Goose CLI
        if: steps.check_api_key.outputs.api_key_exists == 'true' && steps.cache-goose.outputs.cache-hit != 'true'
        run: |
          echo "Installing Goose CLI for AI validation..."
          # Download pre-built binary from GitHub releases
          GOOSE_VERSION="1.23.2"
          mkdir -p ~/goose-bin
          wget -q https://github.com/block/goose/releases/download/v${GOOSE_VERSION}/goose-x86_64-unknown-linux-gnu.tar.bz2
          tar -xjf goose-x86_64-unknown-linux-gnu.tar.bz2 -C ~/goose-bin
          chmod +x ~/goose-bin/goose
          rm goose-x86_64-unknown-linux-gnu.tar.bz2

      - name: Add Goose to PATH
        if: steps.check_api_key.outputs.api_key_exists == 'true'
        run: |
          echo "$HOME/goose-bin" >> $GITHUB_PATH
          ~/goose-bin/goose --version

      - name: Mine publications for novel tools
        id: mining
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          echo "Mining publications for novel tools..."

          # Build command with optional flags
          CMD="python tool_coverage/scripts/fetch_fulltext_and_mine.py"

          # Add max publications limit if specified
          if [ -n "${{ github.event.inputs.max_publications }}" ]; then
            CMD="$CMD --max-publications ${{ github.event.inputs.max_publications }}"
          fi

          # Create outputs directory
          mkdir -p tool_coverage/outputs

          # Run mining
          echo "Running: $CMD"
          $CMD 2>&1 | tee tool_coverage/outputs/mining_output.log || echo "mining_failed=true" >> $GITHUB_OUTPUT

          echo "mining_complete=true" >> $GITHUB_OUTPUT

      - name: Run AI validation on mined tools
        id: validation
        if: steps.check_api_key.outputs.api_key_exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running AI validation on mined tools and candidate publications..."

          # Build command with optional flags
          # Note: --include-unlinked is now the default (fetches from NF portal + unlinked tools pubs)
          CMD="python tool_coverage/scripts/run_publication_reviews.py --mining-file tool_coverage/outputs/processed_publications.csv"

          # Add force re-reviews flag if specified
          if [ "${{ github.event.inputs.force_rereviews }}" = "true" ]; then
            CMD="$CMD --force-rereviews"
          fi

          # Run validation
          echo "Running: $CMD"
          $CMD 2>&1 | tee tool_coverage/outputs/validation_output.log || echo "validation_failed=true" >> $GITHUB_OUTPUT

          echo "validation_complete=true" >> $GITHUB_OUTPUT

      - name: Apply pattern improvements
        id: pattern_improvements
        if: steps.validation.outputs.validation_complete == 'true'
        run: |
          echo "Applying AI-suggested pattern improvements..."
          python tool_coverage/scripts/apply_pattern_suggestions.py 2>&1 | tee pattern_improvements_output.log

          # Check if any files were modified
          if [ -f "tool_coverage/config/mining_patterns.json" ] || [ -f "PATTERN_IMPROVEMENTS.md" ]; then
            echo "pattern_improvements_applied=true" >> $GITHUB_OUTPUT
          fi

      - name: Format mining results for submission
        id: formatting
        run: |
          echo "Formatting mining results into submission CSVs..."
          if [ -f "tool_coverage/outputs/processed_publications.csv" ]; then
            python tool_coverage/scripts/format_mining_for_submission.py 2>&1 | tee tool_coverage/outputs/formatting_output.log
            echo "formatting_complete=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Skipping formatting - no mining results found"
          fi

      - name: Analyze tool coverage
        id: coverage
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          echo "Running coverage analysis with validated results..."
          python tool_coverage/scripts/analyze_missing_tools.py 2>&1 | tee tool_coverage/outputs/coverage_output.log

          # Extract key metrics for summary
          echo "coverage_complete=true" >> $GITHUB_OUTPUT

      - name: Generate summary report
        id: summary
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN }}
        run: |
          python tool_coverage/scripts/generate_coverage_summary.py > pr_body.md

          # Read the summary for the PR body
          echo "PR_BODY<<EOF" >> $GITHUB_OUTPUT
          cat pr_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tool-coverage-reports
          path: |
            tool_coverage/outputs/
            tool_reviews/
            pr_body.md
          if-no-files-found: warn
          retention-days: 30

      - name: Create Pull Request with results
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update tool coverage: automated mining results

            - Coverage report updated
            - Novel tools mined from publications
            - Ready for Synapse upload after review
          branch: tool-coverage-update-${{ github.run_number }}
          delete-branch: true
          title: 'üîç Tool Coverage Update - ${{ github.run_number }}'
          body-path: pr_body.md
          assignees: BelindaBGarana
          labels: |
            automated-mining
            tool-coverage
          add-paths: |
            tool_coverage/outputs/
            tool_coverage/config/mining_patterns.json
            PATTERN_IMPROVEMENTS.md
