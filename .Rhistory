cat("Reading Observation data from Synapse...\n")
obs_query <- synTableQuery(
"SELECT * FROM syn26486836"
)
obs_df <- as.data.frame(obs_query)
# Read publications data
cat("Reading Publication data from Synapse...\n")
pub_query <- synTableQuery(
"SELECT resourceId, publicationId FROM syn26486807"
)
pub_df <- as.data.frame(pub_query)
# Initialize results dataframe
results <- data.frame()
# Calculate scores for each resource
cat("Calculating scores...\n")
for (i in 1:nrow(resource_df)) {
resource <- resource_df[i, ]
# Get observations for this resource
resource_obs <- obs_df %>%
filter(resourceId == resource$resourceId)
# Get observations for this resource
resource_pub <- pub_df %>%
filter(resourceId == resource$resourceId)
# Calculate score
score_result <- calculate_tool_score(resource, resource_obs, resource_pub)
# Create result row
result_row <- data.frame(
resourceId = resource$resourceId,
resourceName = resource$resourceName,
resourceType = resource$resourceType,
rrid = resource$rrid,
total_score = score_result$total_score,
biobank_url_score = ifelse(is.null(score_result$breakdown$biobank_url), NA, score_result$breakdown$biobank_url),
vendor_developer_score = ifelse(is.null(score_result$breakdown$vendor_developer), NA, score_result$breakdown$vendor_developer),
rrid_score = ifelse(is.null(score_result$breakdown$rrid), NA, score_result$breakdown$rrid),
doi_score = ifelse(is.null(score_result$breakdown$doi), NA, score_result$breakdown$doi),
critical_info_score = score_result$breakdown$critical_info,
other_info_score = score_result$breakdown$other_info,
observation_score = score_result$breakdown$observations,
missing_availability = score_result$missing_fields$availability,
missing_critical_info = score_result$missing_fields$critical_info,
missing_other_info = score_result$missing_fields$other_info,
observation_status = score_result$missing_fields$observations,
stringsAsFactors = FALSE
)
results <- rbind(results, result_row)
}
# Add completeness category
results <- results %>%
mutate(
completeness_category = case_when(
total_score >= 80 ~ "Excellent",
total_score >= 60 ~ "Good",
total_score >= 40 ~ "Fair",
total_score >= 20 ~ "Poor",
TRUE ~ "Minimal"
)
)
return(results)
}
# Generate summary statistics by tool type
summarize_scores <- function(scores_df) {
summary_stats <- scores_df %>%
group_by(resourceType) %>%
summarise(
count = n(),
mean_score = mean(total_score, na.rm = TRUE),
median_score = median(total_score, na.rm = TRUE),
min_score = min(total_score, na.rm = TRUE),
max_score = max(total_score, na.rm = TRUE),
sd_score = sd(total_score, na.rm = TRUE),
excellent = sum(completeness_category == "Excellent"),
good = sum(completeness_category == "Good"),
fair = sum(completeness_category == "Fair"),
poor = sum(completeness_category == "Poor"),
minimal = sum(completeness_category == "Minimal")
) %>%
arrange(desc(mean_score))
return(summary_stats)
}
# Run the analysis
cat("Starting tool completeness scoring...\n")
all_scores <- score_all_tools()
# Generate summary
summary_by_type <- summarize_scores(all_scores)
# Display results
cat("\n=== Summary by Tool Type ===\n")
print(summary_by_type)
cat("\n=== Top 10 Most Complete Tools ===\n")
print(all_scores %>%
arrange(desc(total_score)) %>%
select(resourceName, resourceType, rrid, total_score, completeness_category) %>%
head(10))
cat("\n=== Tools Needing Improvement (Score < 40) ===\n")
incomplete_tools <- all_scores %>%
filter(total_score < 40) %>%
arrange(total_score) %>%
select(resourceName, resourceType, total_score, completeness_category)
print(head(incomplete_tools, 20))
# Helper function to find existing table by name
find_existing_table <- function(parent_id, table_name) {
tryCatch({
children <- as.list(synGetChildren(parent_id))
for (child in children) {
if (child$name == table_name && child$type == "org.sagebionetworks.repo.model.table.TableEntity") {
return(child$id)
}
}
return(NULL)
}, error = function(e) {
return(NULL)
})
}
# Store results as a Synapse table
cat("\nStoring results as Synapse table...\n")
# Check if the table already exists
existing_scores_table_id <- find_existing_table("syn26338068", "ToolCompletenessScores")
if (!is.null(existing_scores_table_id)) {
cat("Found existing table:", existing_scores_table_id, "\n")
cat("Updating table with new data (this will create a new version)...\n")
# Delete existing rows from the table
current_data <- synTableQuery(paste0("SELECT * FROM ", existing_scores_table_id))
synDelete(current_data)
# Store new data to the existing table (creates a new version)
table_object <- Table(existing_scores_table_id, all_scores)
table_object$headers <- colnames(all_scores)
synStore(table_object)
synCreateSnapshotVersion(existing_scores_table_id)
cat("\n✓ Completeness scores updated in Synapse table:", existing_scores_table_id, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", existing_scores_table_id, "\n")
} else {
cat("Creating new table...\n")
# Define table schema
table_schema <- Schema(
name = "ToolCompletenessScores",
parent = "syn26338068",
columns = list(
Column(name = "resourceId", columnType = "STRING", maximumSize = 50),
Column(name = "resourceName", columnType = "STRING", maximumSize = 255),
Column(name = "resourceType", columnType = "STRING", maximumSize = 50),
Column(name = "rrid", columnType = "STRING", maximumSize = 100),
Column(name = "total_score", columnType = "DOUBLE"),
Column(name = "biobank_url_score", columnType = "DOUBLE"),
Column(name = "vendor_developer_score", columnType = "DOUBLE"),
Column(name = "rrid_score", columnType = "DOUBLE"),
Column(name = "doi_score", columnType = "DOUBLE"),
Column(name = "critical_info_score", columnType = "DOUBLE"),
Column(name = "other_info_score", columnType = "DOUBLE"),
Column(name = "observation_score", columnType = "DOUBLE"),
Column(name = "missing_availability", columnType = "STRING", maximumSize = 500),
Column(name = "missing_critical_info", columnType = "STRING", maximumSize = 500),
Column(name = "missing_other_info", columnType = "STRING", maximumSize = 500),
Column(name = "observation_status", columnType = "STRING", maximumSize = 200),
Column(name = "completeness_category", columnType = "STRING", maximumSize = 50)
)
)
# Create and store the table
table_object <- Table(table_schema, all_scores)
table_object$headers <- colnames(all_scores)
table_result <- synStore(table_object)
synCreateSnapshotVersion(table_result$tableId)
cat("\n✓ Completeness scores stored as new Synapse table:", table_result$tableId, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", table_result$tableId, "\n")
}
# Also store summary statistics as a separate table
cat("\nStoring summary statistics as Synapse table...\n")
# Check if the summary table already exists
existing_summary_table_id <- find_existing_table("syn26338068", "ToolCompletenessSummary")
if (!is.null(existing_summary_table_id)) {
cat("Found existing summary table:", existing_summary_table_id, "\n")
cat("Updating summary table with new data (this will create a new version)...\n")
# Delete existing rows from the table
current_summary <- synTableQuery(paste0("SELECT * FROM ", existing_summary_table_id))
synDelete(current_summary)
# Store new data to the existing table (creates a new version)
summary_table_object <- Table(existing_summary_table_id, summary_by_type)
summary_table_object$headers <- colnames(summary_by_type)
synStore(summary_table_object)
synCreateSnapshotVersion(existing_summary_table_id)
cat("✓ Summary statistics updated in Synapse table:", existing_summary_table_id, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", existing_summary_table_id, "\n")
} else {
cat("Creating new summary table...\n")
summary_schema <- Schema(
name = "ToolCompletenessSummary",
parent = "syn26338068",
columns = list(
Column(name = "resourceType", columnType = "STRING", maximumSize = 50),
Column(name = "count", columnType = "INTEGER"),
Column(name = "mean_score", columnType = "DOUBLE"),
Column(name = "median_score", columnType = "DOUBLE"),
Column(name = "min_score", columnType = "DOUBLE"),
Column(name = "max_score", columnType = "DOUBLE"),
Column(name = "sd_score", columnType = "DOUBLE"),
Column(name = "excellent", columnType = "INTEGER"),
Column(name = "good", columnType = "INTEGER"),
Column(name = "fair", columnType = "INTEGER"),
Column(name = "poor", columnType = "INTEGER"),
Column(name = "minimal", columnType = "INTEGER")
)
)
# Create and store the summary table
summary_table_object <- Table(summary_schema, summary_by_type)
summary_table_object$headers <- colnames(summary_by_type)
summary_table_result <- synStore(summary_table_object)
synCreateSnapshotVersion(summary_table_result$tableId)
cat("✓ Summary statistics stored as new Synapse table:", summary_table_result$tableId, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", summary_table_result$tableId, "\n")
}
install.packages("tinytex")
install.packages("tinytex")
tinytex::install_tinytex()
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# Load required libraries
library(synapser)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(scales)
library(RColorBrewer)
library(stringr)
# Find most common missing fields
all_missing_fields <- c()
all_missing_types <- c()
all_missing_categories <- c()
for (i in 1:nrow(all_scores)) {
# Availability
if (!is.na(all_scores$missing_availability[i]) && all_scores$missing_availability[i] != "") {
fields <- strsplit(all_scores$missing_availability[i], "; ")[[1]]
all_missing_fields <- c(all_missing_fields, fields)
all_missing_types <- c(all_missing_types, rep(all_scores$resourceType[i], length(fields)))
all_missing_categories <- c(all_missing_categories, rep("Availability", length(fields)))
}
# Critical Info
if (!is.na(all_scores$missing_critical_info[i]) && all_scores$missing_critical_info[i] != "") {
fields <- strsplit(all_scores$missing_critical_info[i], "; ")[[1]]
all_missing_fields <- c(all_missing_fields, fields)
all_missing_types <- c(all_missing_types, rep(all_scores$resourceType[i], length(fields)))
all_missing_categories <- c(all_missing_categories, rep("Critical Info", length(fields)))
}
# Other Info
if (!is.na(all_scores$missing_other_info[i]) && all_scores$missing_other_info[i] != "") {
fields <- strsplit(all_scores$missing_other_info[i], "; ")[[1]]
all_missing_fields <- c(all_missing_fields, fields)
all_missing_types <- c(all_missing_types, rep(all_scores$resourceType[i], length(fields)))
all_missing_categories <- c(all_missing_categories, rep("Other Info", length(fields)))
}
}
missing_field_counts_detailed <- data.frame(
field = all_missing_fields,
resource_type = all_missing_types,
category = all_missing_categories,
stringsAsFactors = FALSE
) %>%
group_by(field, category, resource_type) %>%
summarize(count = n(), .groups = "drop") %>%
arrange(desc(count)) %>%
head(10)
ggplot(missing_field_counts_detailed, aes(x = reorder(field, count), y = count, fill = category)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = c("Availability" = "#e74c3c",
"Critical Info" = "#f39c12",
"Other Info" = "#3498db")) +
labs(title = "Top 10 Most Commonly Missing Fields",
x = "Field Name",
y = "Number of Resources Missing This Field",
fill = "Category") +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(face = "bold", size = 16),
axis.text.x = element_text(size = 10)) + facet_grid(.~resource_type) +
coord_flip()
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# Load required libraries
library(synapser)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(scales)
library(RColorBrewer)
library(stringr)
# Source the scoring script to get the functions
library(synapser)
synLogin()
all_scores <- as.data.frame(synTableQuery("SELECT * FROM syn71218777"))
summary_by_type <- as.data.frame(synTableQuery("SELECT * FROM syn71219401"))
cat(sprintf("\nAnalyzed %d resources across %d resource types\n",
nrow(all_scores),
length(unique(all_scores$resourceType))))
View(all_scores)
# Overall histogram (hidden in HTML output)
ggplot(all_scores, aes(x = total_score)) +
geom_histogram(binwidth = 5, fill = "#3498db", color = "white", alpha = 0.8) +
geom_vline(aes(xintercept = mean(total_score, na.rm = TRUE)),
color = "red", linetype = "dashed", size = 1) +
geom_vline(aes(xintercept = median(total_score, na.rm = TRUE)),
color = "darkgreen", linetype = "dashed", size = 1) +
labs(title = "Overall Completeness Score Distribution",
subtitle = sprintf("Mean: %.1f | Median: %.1f | N = %d",
mean(all_scores$total_score, na.rm = TRUE),
median(all_scores$total_score, na.rm = TRUE),
nrow(all_scores)),
x = "Total Score (out of 100)",
y = "Number of Resources") +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(face = "bold", size = 16))
# Count by completeness category
category_counts <- all_scores %>%
group_by(completeness_category) %>%
summarize(count = n()) %>%
mutate(percentage = count / sum(count) * 100,
completeness_category = factor(completeness_category,
levels = c("Excellent", "Good", "Fair", "Poor", "Minimal")))
# Overall pie chart of completeness categories
ggplot(category_counts, aes(x = "", y = count, fill = completeness_category)) +
geom_bar(stat = "identity", width = 1, color = "white", size = 1.5) +
coord_polar("y", start = 0) +
scale_fill_manual(values = c("Excellent" = "#27ae60", "Good" = "#2ecc71",
"Fair" = "#f39c12", "Poor" = "#e67e22",
"Minimal" = "#e74c3c")) +
geom_text(aes(label = sprintf("%d\n(%.1f%%)", count, percentage)),
position = position_stack(vjust = 0.5),
size = 5, fontface = "bold", color = "white") +
labs(title = "Overall Distribution of Completeness Categories",
subtitle = sprintf("Total: %d resources", sum(category_counts$count)),
fill = "Category") +
theme_void(base_size = 14) +
theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5),
legend.position = "right")
# Pie charts by resource type
category_by_type_pct <- all_scores %>%
group_by(resourceType, completeness_category) %>%
summarize(count = n(), .groups = "drop") %>%
group_by(resourceType) %>%
mutate(
total_resources = sum(count),
percentage = count / sum(count) * 100,
completeness_category = factor(completeness_category,
levels = c("Excellent", "Good", "Fair", "Poor", "Minimal")),
resourceType_label = sprintf("%s (n=%d)", resourceType, total_resources)
) %>%
ungroup()
ggplot(category_by_type_pct, aes(x = "", y = percentage, fill = completeness_category)) +
geom_bar(stat = "identity", width = 1, color = "white", size = 1) +
coord_polar(theta = "y", start = 0) +
scale_fill_manual(values = c("Excellent" = "#27ae60", "Good" = "#2ecc71",
"Fair" = "#f39c12", "Poor" = "#e67e22",
"Minimal" = "#e74c3c")) +
geom_text(aes(label = ifelse(percentage >= 5, sprintf("%.0f%%", percentage), "")),
position = position_stack(vjust = 0.5),
size = 3.5, fontface = "bold", color = "white") +
facet_wrap(~resourceType_label, ncol = 3) +
labs(title = "Completeness Category Distribution by Resource Type",
fill = "Category") +
theme_void(base_size = 12) +
theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
legend.position = "bottom",
strip.text = element_text(size = 12, face = "bold"))
# Prepare missing fields data
missing_data <- all_scores %>%
select(resourceType, missing_availability, missing_critical_info,
missing_other_info, observation_status) %>%
mutate(
n_missing_availability = ifelse(is.na(missing_availability) | missing_availability == "",
0,
str_count(missing_availability, ";") + 1),
n_missing_critical = ifelse(is.na(missing_critical_info) | missing_critical_info == "",
0,
str_count(missing_critical_info, ";") + 1),
n_missing_other = ifelse(is.na(missing_other_info) | missing_other_info == "",
0,
str_count(missing_other_info, ";") + 1),
has_observations = !grepl("No observations", observation_status, fixed = TRUE)
)
# Summary of missing fields by category
missing_summary <- missing_data %>%
group_by(resourceType) %>%
summarize(
avg_missing_availability = mean(n_missing_availability, na.rm = TRUE),
avg_missing_critical = mean(n_missing_critical, na.rm = TRUE),
avg_missing_other = mean(n_missing_other, na.rm = TRUE),
pct_no_observations = sum(!has_observations) / n() * 100,
.groups = "drop"
) %>%
pivot_longer(cols = starts_with("avg_missing"),
names_to = "category",
values_to = "avg_missing") %>%
mutate(category = case_when(
category == "avg_missing_availability" ~ "Availability",
category == "avg_missing_critical" ~ "Critical Info",
category == "avg_missing_other" ~ "Other Info"
))
ggplot(missing_summary, aes(x = resourceType, y = avg_missing, fill = category)) +
geom_bar(stat = "identity", position = "dodge") +
scale_fill_manual(values = c("Availability" = "#e74c3c",
"Critical Info" = "#f39c12",
"Other Info" = "#3498db")) +
labs(title = "Average Number of Missing Fields by Category",
subtitle = "By resource type",
x = "Resource Type",
y = "Average Number of Missing Fields",
fill = "Field Category") +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(face = "bold", size = 16),
axis.text.x = element_text(angle = 45, hjust = 1))
# Find most common missing fields
all_missing_fields <- c()
all_missing_types <- c()
all_missing_categories <- c()
for (i in 1:nrow(all_scores)) {
# Availability
if (!is.na(all_scores$missing_availability[i]) && all_scores$missing_availability[i] != "") {
fields <- strsplit(all_scores$missing_availability[i], "; ")[[1]]
all_missing_fields <- c(all_missing_fields, fields)
all_missing_types <- c(all_missing_types, rep(all_scores$resourceType[i], length(fields)))
all_missing_categories <- c(all_missing_categories, rep("Availability", length(fields)))
}
# Critical Info
if (!is.na(all_scores$missing_critical_info[i]) && all_scores$missing_critical_info[i] != "") {
fields <- strsplit(all_scores$missing_critical_info[i], "; ")[[1]]
all_missing_fields <- c(all_missing_fields, fields)
all_missing_types <- c(all_missing_types, rep(all_scores$resourceType[i], length(fields)))
all_missing_categories <- c(all_missing_categories, rep("Critical Info", length(fields)))
}
# Other Info
if (!is.na(all_scores$missing_other_info[i]) && all_scores$missing_other_info[i] != "") {
fields <- strsplit(all_scores$missing_other_info[i], "; ")[[1]]
all_missing_fields <- c(all_missing_fields, fields)
all_missing_types <- c(all_missing_types, rep(all_scores$resourceType[i], length(fields)))
all_missing_categories <- c(all_missing_categories, rep("Other Info", length(fields)))
}
}
missing_field_counts_detailed <- data.frame(
field = all_missing_fields,
resource_type = all_missing_types,
category = all_missing_categories,
stringsAsFactors = FALSE
) %>%
group_by(field, category, resource_type) %>%
summarize(count = n(), .groups = "drop") %>%
arrange(desc(count)) %>%
head(10)
ggplot(missing_field_counts_detailed, aes(x = reorder(field, count), y = count, fill = category)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = c("Availability" = "#e74c3c",
"Critical Info" = "#f39c12",
"Other Info" = "#3498db")) +
labs(title = "Top 10 Most Commonly Missing Fields",
x = "Field Name",
y = "Number of Resources Missing This Field",
fill = "Category") +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(face = "bold", size = 16),
axis.text.x = element_text(size = 10)) + facet_grid(.~resource_type) +
coord_flip()
# Observation status distribution
obs_status_summary <- missing_data %>%
group_by(resourceType) %>%
summarize(
has_observations = sum(has_observations),
no_observations = sum(!has_observations),
.groups = "drop"
) %>%
pivot_longer(cols = c(has_observations, no_observations),
names_to = "status",
values_to = "count") %>%
mutate(status = ifelse(status == "has_observations",
"Has Observations",
"No Observations"))
ggplot(obs_status_summary, aes(x = resourceType, y = count, fill = status)) +
geom_bar(stat = "identity", position = "stack") +
scale_fill_manual(values = c("Has Observations" = "#27ae60",
"No Observations" = "#e74c3c")) +
labs(title = "Observation Status by Resource Type",
x = "Resource Type",
y = "Number of Resources",
fill = "Status") +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(face = "bold", size = 16),
axis.text.x = element_text(angle = 45, hjust = 1))
View(summary_by_type)
# Prepare data for component breakdown
component_data <- all_scores %>%
select(resourceType,
biobank_url_score, vendor_developer_score, rrid_score, doi_score,
critical_info_score, other_info_score, observation_score) %>%
pivot_longer(cols = -resourceType,
names_to = "component",
values_to = "score") %>%
mutate(component = gsub("_score", "", component),
component = gsub("_", " ", component),
component = tools::toTitleCase(component))
# Calculate mean scores by component and resource type
component_means <- component_data %>%
group_by(resourceType, component) %>%
summarize(mean_score = mean(score, na.rm = TRUE), .groups = "drop")
# Heatmap of mean component scores by resource type
ggplot(component_means, aes(x = component, y = resourceType, fill = mean_score)) +
geom_tile(color = "white", size = 0.5) +
geom_text(aes(label = sprintf("%.1f", mean_score)), color = "white", fontface = "bold") +
scale_fill_gradient2(low = "#e74c3c", mid = "#f39c12", high = "#27ae60",
midpoint = 15, na.value = "grey90") +
labs(title = "Mean Score by Component and Resource Type",
subtitle = "Higher values indicate better completeness",
x = "Score Component",
y = "Resource Type",
fill = "Mean Score") +
theme_minimal(base_size = 12) +
theme(plot.title = element_text(face = "bold", size = 16),
axis.text.x = element_text(angle = 45, hjust = 1))
