)
# Read observations data
cat("Reading Observation data from Synapse...\n")
obs_query <- synTableQuery(
"SELECT * FROM syn26486836"
)
obs_df <- as.data.frame(obs_query)
# Read publications data
cat("Reading Publication data from Synapse...\n")
pub_query <- synTableQuery(
"SELECT resourceId, publicationId FROM syn26486807"
)
pub_df <- as.data.frame(pub_query)
# Initialize results dataframe
results <- data.frame()
# Calculate scores for each resource
cat("Calculating scores...\n")
for (i in 1:nrow(resource_df)) {
resource <- resource_df[i, ]
# Get observations for this resource
resource_obs <- obs_df %>%
filter(resourceId == resource$resourceId)
# Get observations for this resource
resource_pub <- pub_df %>%
filter(resourceId == resource$resourceId)
# Calculate score
score_result <- calculate_tool_score(resource, resource_obs, resource_pub)
# Create result row
result_row <- data.frame(
resourceId = resource$resourceId,
resourceName = resource$resourceName,
resourceType = resource$resourceType,
rrid = resource$rrid,
total_score = score_result$total_score,
availability_score = ifelse(is.null(score_result$breakdown$availability), NA, score_result$breakdown$availability),
biobank_url_score = ifelse(is.null(score_result$breakdown$biobank_url), NA, score_result$breakdown$biobank_url),
vendor_developer_score = ifelse(is.null(score_result$breakdown$vendor_developer), NA, score_result$breakdown$vendor_developer),
rrid_score = ifelse(is.null(score_result$breakdown$rrid), NA, score_result$breakdown$rrid),
doi_score = ifelse(is.null(score_result$breakdown$doi), NA, score_result$breakdown$doi),
critical_info_score = score_result$breakdown$critical_info,
other_info_score = score_result$breakdown$other_info,
observation_score = score_result$breakdown$observations,
missing_availability = score_result$missing_fields$availability,
missing_critical_info = score_result$missing_fields$critical_info,
missing_other_info = score_result$missing_fields$other_info,
observation_status = score_result$missing_fields$observations,
stringsAsFactors = FALSE
)
results <- rbind(results, result_row)
}
# Add completeness categories
results <- results %>%
mutate(
completeness_category = case_when(
total_score >= 80 ~ "Excellent",
total_score >= 60 ~ "Good",
total_score >= 40 ~ "Fair",
total_score >= 20 ~ "Poor",
TRUE ~ "Minimal"
),
availability_category = case_when(
availability_score == 30 ~ "All",
availability_score > 0 ~ "Some",
TRUE ~ "No"
),
critical_info_category = case_when(
critical_info_score == 30 ~ "All",
critical_info_score > 0 ~ "Some",
TRUE ~ "No"
),
other_info_category = case_when(
other_info_score == 15 ~ "All",
other_info_score > 0 ~ "Some",
TRUE ~ "No"
),
observation_category = case_when(
observation_score == 25 ~ "All",
observation_score > 0 ~ "Some",
TRUE ~ "No"
)
)
return(results)
}
# Generate summary statistics by tool type
summarize_scores <- function(scores_df) {
summary_stats <- scores_df %>%
group_by(resourceType) %>%
summarise(
count = n(),
mean_score = mean(total_score, na.rm = TRUE),
median_score = median(total_score, na.rm = TRUE),
min_score = min(total_score, na.rm = TRUE),
max_score = max(total_score, na.rm = TRUE),
sd_score = sd(total_score, na.rm = TRUE),
excellent = sum(completeness_category == "Excellent"),
good = sum(completeness_category == "Good"),
fair = sum(completeness_category == "Fair"),
poor = sum(completeness_category == "Poor"),
minimal = sum(completeness_category == "Minimal")
) %>%
arrange(desc(mean_score))
return(summary_stats)
}
#### score tools ####
# Run the analysis
cat("Starting tool completeness scoring...\n")
all_scores <- score_all_tools()
# Generate summary
summary_by_type <- summarize_scores(all_scores)
# Display results
cat("\n=== Summary by Tool Type ===\n")
print(summary_by_type)
cat("\n=== Top 10 Most Complete Tools ===\n")
print(all_scores %>%
arrange(desc(total_score)) %>%
select(resourceName, resourceType, rrid, total_score, completeness_category) %>%
head(10))
cat("\n=== Tools Needing Improvement (Score < 40) ===\n")
incomplete_tools <- all_scores %>%
filter(total_score < 40) %>%
arrange(total_score) %>%
select(resourceName, resourceType, total_score, completeness_category)
print(head(incomplete_tools, 20))
#### update Synapse tables ####
# Helper function to find existing table by name
find_existing_table <- function(parent_id, table_name) {
tryCatch({
children <- as.list(synGetChildren(parent_id))
for (child in children) {
if (child$name == table_name && child$type == "org.sagebionetworks.repo.model.table.TableEntity") {
return(child$id)
}
}
return(NULL)
}, error = function(e) {
return(NULL)
})
}
# Store results as a Synapse table
cat("\nStoring results as Synapse table...\n")
# Check if the table already exists
existing_scores_table_id <- find_existing_table("syn26338068", "ToolCompletenessScores")
if (!is.null(existing_scores_table_id)) {
cat("Found existing table:", existing_scores_table_id, "\n")
cat("Updating table with new data (this will create a new version)...\n")
# Delete existing rows from the table
current_data <- synTableQuery(paste0("SELECT * FROM ", existing_scores_table_id))
synDelete(current_data)
# Store new data to the existing table (creates a new version)
table_object <- Table(existing_scores_table_id, all_scores)
table_object$headers <- colnames(all_scores)
synStore(table_object)
synCreateSnapshotVersion(existing_scores_table_id)
cat("\n✓ Completeness scores updated in Synapse table:", existing_scores_table_id, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", existing_scores_table_id, "\n")
} else {
cat("Creating new table...\n")
# Define table schema
table_schema <- Schema(
name = "ToolCompletenessScores",
parent = "syn26338068",
columns = list(
Column(name = "resourceId", columnType = "STRING", maximumSize = 50),
Column(name = "resourceName", columnType = "STRING", maximumSize = 255),
Column(name = "resourceType", columnType = "STRING", maximumSize = 50),
Column(name = "rrid", columnType = "STRING", maximumSize = 100),
Column(name = "total_score", columnType = "DOUBLE"),
Column(name = "availability_score", columnType = "DOUBLE"),
Column(name = "biobank_url_score", columnType = "DOUBLE"),
Column(name = "vendor_developer_score", columnType = "DOUBLE"),
Column(name = "rrid_score", columnType = "DOUBLE"),
Column(name = "doi_score", columnType = "DOUBLE"),
Column(name = "critical_info_score", columnType = "DOUBLE"),
Column(name = "other_info_score", columnType = "DOUBLE"),
Column(name = "observation_score", columnType = "DOUBLE"),
Column(name = "missing_availability", columnType = "STRING", maximumSize = 500),
Column(name = "missing_critical_info", columnType = "STRING", maximumSize = 500),
Column(name = "missing_other_info", columnType = "STRING", maximumSize = 500),
Column(name = "observation_status", columnType = "STRING", maximumSize = 200),
Column(name = "completeness_category", columnType = "STRING", maximumSize = 50),
Column(name = "availability_category", columnType = "STRING", maximumSize = 4),
Column(name = "critical_info_category", columnType = "STRING", maximumSize = 4),
Column(name = "other_info_category", columnType = "STRING", maximumSize = 4),
Column(name = "observation_category", columnType = "STRING", maximumSize = 4)
)
)
# Create and store the table
table_object <- Table(table_schema, all_scores)
table_object$headers <- colnames(all_scores)
table_result <- synStore(table_object)
synCreateSnapshotVersion(table_result$tableId)
cat("\n✓ Completeness scores stored as new Synapse table:", table_result$tableId, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", table_result$tableId, "\n")
existing_scores_table_id <- table_result$tableId
}
# Also store summary statistics as a separate table
cat("\nStoring summary statistics as Synapse table...\n")
# Check if the summary table already exists
existing_summary_table_id <- find_existing_table("syn26338068", "ToolCompletenessSummary")
if (!is.null(existing_summary_table_id)) {
cat("Found existing summary table:", existing_summary_table_id, "\n")
cat("Updating summary table with new data (this will create a new version)...\n")
# Delete existing rows from the table
current_summary <- synTableQuery(paste0("SELECT * FROM ", existing_summary_table_id))
synDelete(current_summary)
# Store new data to the existing table (creates a new version)
summary_table_object <- Table(existing_summary_table_id, summary_by_type)
summary_table_object$headers <- colnames(summary_by_type)
synStore(summary_table_object)
synCreateSnapshotVersion(existing_summary_table_id)
cat("✓ Summary statistics updated in Synapse table:", existing_summary_table_id, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", existing_summary_table_id, "\n")
} else {
cat("Creating new summary table...\n")
summary_schema <- Schema(
name = "ToolCompletenessSummary",
parent = "syn26338068",
columns = list(
Column(name = "resourceType", columnType = "STRING", maximumSize = 50),
Column(name = "count", columnType = "INTEGER"),
Column(name = "mean_score", columnType = "DOUBLE"),
Column(name = "median_score", columnType = "DOUBLE"),
Column(name = "min_score", columnType = "DOUBLE"),
Column(name = "max_score", columnType = "DOUBLE"),
Column(name = "sd_score", columnType = "DOUBLE"),
Column(name = "excellent", columnType = "INTEGER"),
Column(name = "good", columnType = "INTEGER"),
Column(name = "fair", columnType = "INTEGER"),
Column(name = "poor", columnType = "INTEGER"),
Column(name = "minimal", columnType = "INTEGER")
)
)
# Create and store the summary table
summary_table_object <- Table(summary_schema, summary_by_type)
summary_table_object$headers <- colnames(summary_by_type)
summary_table_result <- synStore(summary_table_object)
synCreateSnapshotVersion(summary_table_result$tableId)
cat("✓ Summary statistics stored as new Synapse table:", summary_table_result$tableId, "\n")
cat("  View at: https://www.synapse.org/#!Synapse:", summary_table_result$tableId, "\n")
}
# Update materialized view with completeness scores
cat("\nUpdating materialized view syn51730943 with completeness scores...\n")
# Get the scores table ID (either existing or just created)
scores_table_id <- if (!is.null(existing_scores_table_id)) {
existing_scores_table_id
} else {
"syn71218777"  # Default to the known scores table ID
}
cat("Using scores table:", scores_table_id, "\n")
#### update Synapse materialized view ####
# Function to update materialized view with completeness scores
update_materialized_view <- function(view_id, scores_table_id) {
tryCatch({
# Get the current materialized view
cat("Fetching materialized view:", view_id, "\n")
mv <- synGet(view_id)
# Get the current defining SQL
current_sql <- mv$properties$definingSQL
cat("Current defining SQL:\n", current_sql, "\n\n")
# Create new SQL that includes the completeness scores
# This will add a LEFT JOIN to include the scores columns
new_sql <- paste0(
"SELECT
R.resourceId AS resourceId,
R.rrid AS rrid,
R.resourceName AS resourceName,
R.synonyms AS synonyms,
R.description AS description,
R.resourceType AS resourceType,
D_I.investigatorName AS investigatorName,
D_I.institution AS institution,
D_I.orcid AS orcid,
R.usageRequirements AS usageRequirements,
R.howToAcquire as howToAcquire,
AM_CL_R_DON.species AS species,
CL.cellLineCategory AS cellLineCategory,
CL.cellLineGeneticDisorder AS cellLineGeneticDisorder,
CL.cellLineManifestation AS cellLineManifestation,
AM.backgroundStrain AS backgroundStrain,
AM.backgroundSubstrain AS backgroundSubstrain,
AM.animalModelGeneticDisorder AS animalModelGeneticDisorder,
AM.animalModelOfManifestation AS animalModelOfManifestation,
GR.insertName AS insertName,
GR.insertSpecies AS insertSpecies,
GR.vectorType AS vectorType,
AB.targetAntigen AS targetAntigen,
AB.reactiveSpecies AS reactiveSpecies,
AB.hostOrganism AS hostOrganism,
BB.biobankName AS biobankName,
BB.biobankURL AS biobankURL,
BB.specimenTissueType AS specimenTissueType,
BB.specimenPreparationMethod AS specimenPreparationMethod,
BB.diseaseType AS diseaseType,
BB.tumorType AS tumorType,
BB.specimenFormat AS specimenFormat,
BB.specimenType AS specimenType,
BB.contact AS contact,
D_F.funderName AS funderName,
AM_CL_R_DON.race AS race,
AM_CL_R_DON.sex AS sex,
AM_CL_R_DON.age AS age,
R.dateAdded AS dateAdded,
R.dateModified AS dateModified,
L_P.latestPublicationDate AS latestPublicationDate,
S.completeness_category AS completenessCategory,
S.availability_category AS availabilityCategory,
S.critical_info_category AS criticalInfoCategory,
S.other_info_category AS otherInfoCategory,
S.observation_category AS observationCategory
FROM
syn26450069 R
LEFT JOIN
syn26486823 CL ON (R.cellLineId = CL.cellLineId)
LEFT JOIN
syn26486808 AM ON (R.animalModelId = AM.animalModelId)
LEFT JOIN
syn26486832 GR ON (R.geneticReagentId = GR.geneticReagentId)
LEFT JOIN
syn26486811 AB ON (R.antibodyId = AB.antibodyId)
LEFT JOIN
syn26486821 BB ON (R.resourceId = BB.resourceId)
LEFT JOIN
syn51734029 D_I ON (R.resourceId = D_I.resourceId)
LEFT JOIN
syn51734076 D_F ON (R.resourceId = D_F.resourceId)
LEFT JOIN
syn51735419 AM_CL_R_DON ON (R.resourceId = AM_CL_R_DON.resourceId)
LEFT JOIN
syn62139114 L_P ON (R.resourceId = L_P.resourceId)
LEFT JOIN
", scores_table_id," S ON (R.resourceId = S.resourceId)"
)
#     new_sql <- paste0(
#       "SELECT
#     R.resourceId AS resourceId,
#     R.rrid AS rrid,
#     R.resourceName AS resourceName,
#     R.synonyms AS synonyms,
#     R.description AS description,
#
#     R.resourceType AS resourceType,
#
#     D_I.investigatorName AS investigatorName,
#     D_I.institution AS institution,
#     D_I.orcid AS orcid,
#
#     R.usageRequirements AS usageRequirements,
#     R.howToAcquire as howToAcquire,
#
#     AM_CL_R_DON.species AS species,
#
#     CL.cellLineCategory AS cellLineCategory,
#     CL.cellLineGeneticDisorder AS cellLineGeneticDisorder,
#     CL.cellLineManifestation AS cellLineManifestation,
#     AM.backgroundStrain AS backgroundStrain,
#     AM.backgroundSubstrain AS backgroundSubstrain,
#     AM.animalModelGeneticDisorder AS animalModelGeneticDisorder,
#     AM.animalModelOfManifestation AS animalModelOfManifestation,
#     GR.insertName AS insertName,
#     GR.insertSpecies AS insertSpecies,
#     GR.vectorType AS vectorType,
#     AB.targetAntigen AS targetAntigen,
#     AB.reactiveSpecies AS reactiveSpecies,
#     AB.hostOrganism AS hostOrganism,
#     BB.biobankName AS biobankName,
#     BB.biobankURL AS biobankURL,
#     BB.specimenTissueType AS specimenTissueType,
#     BB.specimenPreparationMethod AS specimenPreparationMethod,
#     BB.diseaseType AS diseaseType,
#     BB.tumorType AS tumorType,
#     BB.specimenFormat AS specimenFormat,
#     BB.specimenType AS specimenType,
#     BB.contact AS contact,
#     D_F.funderName AS funderName,
#     AM_CL_R_DON.race AS race,
#     AM_CL_R_DON.sex AS sex,
#     AM_CL_R_DON.age AS age,
#     R.dateAdded AS dateAdded,
#     R.dateModified AS dateModified,
#     L_P.latestPublicationDate AS latestPublicationDate,
#     S.availability_score AS availabilityScore,
#     S.critical_info_score AS criticalInfoScore,
#     S.other_info_score AS otherInfoScore,
#     S.observation_score AS observationScore,
#     CONCAT(S.missing_availability, '; ', S.missing_critical_info, '; ', S.missing_other_info) AS missingInfo
# FROM
#     syn26450069 R
# LEFT JOIN
#     syn26486823 CL ON (R.cellLineId = CL.cellLineId)
# LEFT JOIN
#     syn26486808 AM ON (R.animalModelId = AM.animalModelId)
# LEFT JOIN
#     syn26486832 GR ON (R.geneticReagentId = GR.geneticReagentId)
# LEFT JOIN
#     syn26486811 AB ON (R.antibodyId = AB.antibodyId)
# LEFT JOIN
#     syn26486821 BB ON (R.resourceId = BB.resourceId)
# LEFT JOIN
#     syn51734029 D_I ON (R.resourceId = D_I.resourceId)
# LEFT JOIN
#     syn51734076 D_F ON (R.resourceId = D_F.resourceId)
# LEFT JOIN
#     syn51735419 AM_CL_R_DON ON (R.resourceId = AM_CL_R_DON.resourceId)
# LEFT JOIN
#     syn62139114 L_P ON (R.resourceId = L_P.resourceId)
# LEFT JOIN
#       ", scores_table_id," S ON (R.resourceId = S.resourceId)"
#     )
#
#     new_sql <- paste0(
#       "SELECT
#     R.resourceId AS resourceId,
#     R.rrid AS rrid,
#     R.resourceName AS resourceName,
#     R.synonyms AS synonyms,
#     R.description AS description,
#
#     R.resourceType AS resourceType,
#
#     D_I.investigatorName AS investigatorName,
#     D_I.institution AS institution,
#     D_I.orcid AS orcid,
#
#     R.usageRequirements AS usageRequirements,
#     R.howToAcquire as howToAcquire,
#
#     AM_CL_R_DON.species AS species,
#
#     CL.cellLineCategory AS cellLineCategory,
#     CL.cellLineGeneticDisorder AS cellLineGeneticDisorder,
#     CL.cellLineManifestation AS cellLineManifestation,
#     AM.backgroundStrain AS backgroundStrain,
#     AM.backgroundSubstrain AS backgroundSubstrain,
#     AM.animalModelGeneticDisorder AS animalModelGeneticDisorder,
#     AM.animalModelOfManifestation AS animalModelOfManifestation,
#     GR.insertName AS insertName,
#     GR.insertSpecies AS insertSpecies,
#     GR.vectorType AS vectorType,
#     AB.targetAntigen AS targetAntigen,
#     AB.reactiveSpecies AS reactiveSpecies,
#     AB.hostOrganism AS hostOrganism,
#     BB.biobankName AS biobankName,
#     BB.biobankURL AS biobankURL,
#     BB.specimenTissueType AS specimenTissueType,
#     BB.specimenPreparationMethod AS specimenPreparationMethod,
#     BB.diseaseType AS diseaseType,
#     BB.tumorType AS tumorType,
#     BB.specimenFormat AS specimenFormat,
#     BB.specimenType AS specimenType,
#     BB.contact AS contact,
#     D_F.funderName AS funderName,
#     AM_CL_R_DON.race AS race,
#     AM_CL_R_DON.sex AS sex,
#     AM_CL_R_DON.age AS age,
#     R.dateAdded AS dateAdded,
#     R.dateModified AS dateModified,
#     L_P.latestPublicationDate AS latestPublicationDate,
#     S.total_score AS completenessScore,
#     S.completeness_category AS completenessCategory,
#     S.availability_score AS availabilityScore,
#     S.critical_info_score AS criticalInfoScore,
#     S.other_info_score AS otherInfoScore,
#     S.observation_score AS observationScore,
#     S.missing_availability AS missingAvailability,
#     S.missing_critical_info AS missingCriticalInfo,
#     S.missing_other_info AS missingOtherInfo,
#     S.observation_status AS observationStatus
# FROM
#     syn26450069 R
# LEFT JOIN
#     syn26486823 CL ON (R.cellLineId = CL.cellLineId)
# LEFT JOIN
#     syn26486808 AM ON (R.animalModelId = AM.animalModelId)
# LEFT JOIN
#     syn26486832 GR ON (R.geneticReagentId = GR.geneticReagentId)
# LEFT JOIN
#     syn26486811 AB ON (R.antibodyId = AB.antibodyId)
# LEFT JOIN
#     syn26486821 BB ON (R.resourceId = BB.resourceId)
# LEFT JOIN
#     syn51734029 D_I ON (R.resourceId = D_I.resourceId)
# LEFT JOIN
#     syn51734076 D_F ON (R.resourceId = D_F.resourceId)
# LEFT JOIN
#     syn51735419 AM_CL_R_DON ON (R.resourceId = AM_CL_R_DON.resourceId)
# LEFT JOIN
#     syn62139114 L_P ON (R.resourceId = L_P.resourceId)
# LEFT JOIN
#       ", scores_table_id," S ON (R.resourceId = S.resourceId)"
#     )
cat("New defining SQL:\n", new_sql, "\n\n")
# Update the materialized view with new SQL
mv$properties$definingSQL <- new_sql
updated_mv <- synStore(mv)
cat("✓ Materialized view updated successfully!\n")
cat("  View at: https://www.synapse.org/#!Synapse:", view_id, "\n")
return(TRUE)
}, error = function(e) {
cat("✗ Error updating materialized view:", conditionMessage(e), "\n")
cat("  You may need to update the materialized view manually.\n")
cat("  The scores are available in table:", scores_table_id, "\n")
return(FALSE)
})
}
# Attempt to update the materialized view
update_success <- update_materialized_view("syn51730943", existing_scores_table_id)
if (update_success) {
cat("\n✓ All tasks completed successfully!\n")
} else {
cat("\n⚠ Materialized view update failed. Please update manually.\n")
cat("  Need to join", existing_scores_table_id, "with syn51730943 on resourceId column.\n")
}
