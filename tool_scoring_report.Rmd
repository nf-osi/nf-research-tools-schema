---
title: "Research Tools Completeness Score Report"
author: "NF-OSI"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    highlight: tango
    code_folding: hide
    fig_width: 10
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required libraries
library(synapser)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(DT)
library(scales)
library(RColorBrewer)
```

## Executive Summary

This report provides a comprehensive analysis of the completeness scores for research tools and biobanks in the NF-OSI database. The scoring system evaluates resources across multiple dimensions:

- **Availability** (40 points): Biobank URL, vendor/developer info, RRID, and DOI
- **Critical Info** (30 points): Type-specific essential fields
- **Other Info** (20 points): Type-specific additional fields
- **Observations** (10 points): Scientific characterizations with DOI weighting

**Total Maximum Score: 100 points**

---

## Data Loading

```{r load-data}
# Source the scoring script to get the functions
source("tool_scoring.R")

# Check if scores already exist as CSV
if (file.exists("tool_completeness_scores.csv")) {
  cat("Loading existing scores from CSV...\n")
  all_scores <- read.csv("tool_completeness_scores.csv", stringsAsFactors = FALSE)
  summary_by_type <- read.csv("tool_completeness_summary.csv", stringsAsFactors = FALSE)
} else {
  cat("Running scoring analysis...\n")
  # Login to Synapse if needed
  synLogin()

  # Run the scoring
  all_scores <- score_all_tools()
  summary_by_type <- summarize_scores(all_scores)

  # Save results
  write.csv(all_scores, "tool_completeness_scores.csv", row.names = FALSE)
  write.csv(summary_by_type, "tool_completeness_summary.csv", row.names = FALSE)
}

cat(sprintf("\nAnalyzed %d resources across %d resource types\n",
            nrow(all_scores),
            length(unique(all_scores$resourceType))))
```

---

## Overall Score Distribution

```{r overall-distribution, fig.height=6}
# Overall histogram
ggplot(all_scores, aes(x = total_score)) +
  geom_histogram(binwidth = 5, fill = "#3498db", color = "white", alpha = 0.8) +
  geom_vline(aes(xintercept = mean(total_score, na.rm = TRUE)),
             color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = median(total_score, na.rm = TRUE)),
             color = "darkgreen", linetype = "dashed", size = 1) +
  labs(title = "Overall Completeness Score Distribution",
       subtitle = sprintf("Mean: %.1f | Median: %.1f | N = %d",
                         mean(all_scores$total_score, na.rm = TRUE),
                         median(all_scores$total_score, na.rm = TRUE),
                         nrow(all_scores)),
       x = "Total Score (out of 100)",
       y = "Number of Resources") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16))
```

```{r overall-boxplot}
# Overall boxplot with completeness categories
ggplot(all_scores, aes(y = total_score, x = "All Resources", fill = completeness_category)) +
  geom_boxplot(width = 0.5, outlier.shape = 21, outlier.size = 3) +
  scale_fill_brewer(palette = "RdYlGn", direction = 1) +
  labs(title = "Overall Score Distribution by Completeness Category",
       y = "Total Score",
       x = "",
       fill = "Category") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16),
        axis.text.x = element_text(size = 12, face = "bold")) +
  coord_flip()
```

---

## Score Distribution by Resource Type

```{r by-type-boxplot, fig.height=8}
# Order resource types by median score
type_order <- all_scores %>%
  group_by(resourceType) %>%
  summarize(median_score = median(total_score, na.rm = TRUE)) %>%
  arrange(desc(median_score)) %>%
  pull(resourceType)

all_scores$resourceType <- factor(all_scores$resourceType, levels = type_order)

# Boxplot by resource type
ggplot(all_scores, aes(x = resourceType, y = total_score, fill = resourceType)) +
  geom_boxplot(outlier.shape = 21, outlier.size = 2) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  scale_fill_brewer(palette = "Set3") +
  labs(title = "Completeness Score Distribution by Resource Type",
       subtitle = "Ordered by median score (highest to lowest)",
       x = "Resource Type",
       y = "Total Score (out of 100)") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

```{r by-type-violin}
# Violin plot by resource type
ggplot(all_scores, aes(x = resourceType, y = total_score, fill = resourceType)) +
  geom_violin(alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  scale_fill_brewer(palette = "Set3") +
  labs(title = "Score Distribution Density by Resource Type",
       x = "Resource Type",
       y = "Total Score (out of 100)") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

---

## Completeness Category Distribution

```{r category-distribution}
# Count by completeness category
category_counts <- all_scores %>%
  group_by(completeness_category) %>%
  summarize(count = n()) %>%
  mutate(percentage = count / sum(count) * 100,
         completeness_category = factor(completeness_category,
                                       levels = c("Excellent", "Good", "Fair", "Poor", "Minimal")))

# Bar chart of completeness categories
ggplot(category_counts, aes(x = completeness_category, y = count, fill = completeness_category)) +
  geom_bar(stat = "identity", color = "white") +
  geom_text(aes(label = sprintf("%d\n(%.1f%%)", count, percentage)),
            vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_manual(values = c("Excellent" = "#27ae60", "Good" = "#2ecc71",
                               "Fair" = "#f39c12", "Poor" = "#e67e22",
                               "Minimal" = "#e74c3c")) +
  labs(title = "Distribution of Completeness Categories",
       subtitle = "Total resources analyzed",
       x = "Completeness Category",
       y = "Number of Resources") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16),
        legend.position = "none") +
  ylim(0, max(category_counts$count) * 1.15)
```

```{r category-by-type}
# Stacked bar chart by resource type
category_by_type <- all_scores %>%
  group_by(resourceType, completeness_category) %>%
  summarize(count = n(), .groups = "drop") %>%
  mutate(completeness_category = factor(completeness_category,
                                       levels = c("Minimal", "Poor", "Fair", "Good", "Excellent")))

ggplot(category_by_type, aes(x = resourceType, y = count, fill = completeness_category)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Minimal" = "#e74c3c", "Poor" = "#e67e22",
                               "Fair" = "#f39c12", "Good" = "#2ecc71",
                               "Excellent" = "#27ae60")) +
  labs(title = "Completeness Categories by Resource Type",
       x = "Resource Type",
       y = "Number of Resources",
       fill = "Category") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

---

## Score Component Breakdown

```{r score-components}
# Prepare data for component breakdown
component_data <- all_scores %>%
  select(resourceType,
         biobank_url_score, vendor_developer_score, rrid_score, doi_score,
         critical_info_score, other_info_score, observation_score) %>%
  pivot_longer(cols = -resourceType,
               names_to = "component",
               values_to = "score") %>%
  mutate(component = gsub("_score", "", component),
         component = gsub("_", " ", component),
         component = tools::toTitleCase(component))

# Calculate mean scores by component and resource type
component_means <- component_data %>%
  group_by(resourceType, component) %>%
  summarize(mean_score = mean(score, na.rm = TRUE), .groups = "drop")

# Heatmap of mean component scores by resource type
ggplot(component_means, aes(x = component, y = resourceType, fill = mean_score)) +
  geom_tile(color = "white", size = 0.5) +
  geom_text(aes(label = sprintf("%.1f", mean_score)), color = "white", fontface = "bold") +
  scale_fill_gradient2(low = "#e74c3c", mid = "#f39c12", high = "#27ae60",
                      midpoint = 15, na.value = "grey90") +
  labs(title = "Mean Score by Component and Resource Type",
       subtitle = "Higher values indicate better completeness",
       x = "Score Component",
       y = "Resource Type",
       fill = "Mean Score") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r component-contribution}
# Overall component contribution
component_overall <- component_data %>%
  group_by(component) %>%
  summarize(mean_score = mean(score, na.rm = TRUE),
            max_possible = case_when(
              component %in% c("Biobank Url") ~ 40,
              component %in% c("Vendor Developer") ~ 20,
              component %in% c("Rrid", "Doi") ~ 10,
              component == "Critical Info" ~ 30,
              component == "Other Info" ~ 20,
              component == "Observation" ~ 10,
              TRUE ~ NA_real_
            )) %>%
  filter(!is.na(max_possible)) %>%
  mutate(percent_filled = (mean_score / max_possible) * 100)

# Bar chart of component contribution
ggplot(component_overall, aes(x = reorder(component, mean_score), y = mean_score)) +
  geom_bar(stat = "identity", aes(fill = percent_filled), color = "white") +
  geom_text(aes(label = sprintf("%.1f\n(%.1f%%)", mean_score, percent_filled)),
            hjust = -0.1, size = 4) +
  scale_fill_gradient2(low = "#e74c3c", mid = "#f39c12", high = "#27ae60",
                      midpoint = 50) +
  labs(title = "Average Score Contribution by Component",
       subtitle = "Across all resource types",
       x = "Component",
       y = "Mean Score",
       fill = "% of Max") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16)) +
  coord_flip() +
  ylim(0, max(component_overall$mean_score) * 1.2)
```

---

## Summary Statistics Tables

### Overall Statistics

```{r overall-stats-table}
overall_stats <- data.frame(
  Metric = c("Total Resources", "Mean Score", "Median Score", "Std Dev",
             "Min Score", "Max Score", "Range"),
  Value = c(
    nrow(all_scores),
    round(mean(all_scores$total_score, na.rm = TRUE), 2),
    round(median(all_scores$total_score, na.rm = TRUE), 2),
    round(sd(all_scores$total_score, na.rm = TRUE), 2),
    round(min(all_scores$total_score, na.rm = TRUE), 2),
    round(max(all_scores$total_score, na.rm = TRUE), 2),
    round(max(all_scores$total_score, na.rm = TRUE) -
          min(all_scores$total_score, na.rm = TRUE), 2)
  )
)

kable(overall_stats, caption = "Overall Summary Statistics", align = c("l", "r"))
```

### Statistics by Resource Type

```{r type-stats-table}
type_stats <- summary_by_type %>%
  select(resourceType, count, mean_score, median_score, sd_score, min_score, max_score) %>%
  arrange(desc(mean_score)) %>%
  mutate(across(where(is.numeric), ~round(., 2)))

colnames(type_stats) <- c("Resource Type", "Count", "Mean", "Median", "Std Dev", "Min", "Max")

datatable(type_stats,
          caption = "Summary Statistics by Resource Type",
          options = list(pageLength = 15,
                        autoWidth = TRUE),
          rownames = FALSE) %>%
  formatStyle(columns = "Mean",
              background = styleColorBar(type_stats$Mean, '#3498db'),
              backgroundSize = '100% 90%',
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```

### Top 20 Most Complete Resources

```{r top-resources}
top_resources <- all_scores %>%
  arrange(desc(total_score)) %>%
  select(resourceName, resourceType, rrid, total_score, completeness_category) %>%
  head(20) %>%
  mutate(total_score = round(total_score, 1))

colnames(top_resources) <- c("Resource Name", "Type", "RRID", "Score", "Category")

datatable(top_resources,
          caption = "Top 20 Most Complete Resources",
          options = list(pageLength = 20),
          rownames = FALSE) %>%
  formatStyle(columns = "Category",
              backgroundColor = styleEqual(
                c("Excellent", "Good", "Fair", "Poor", "Minimal"),
                c("#27ae60", "#2ecc71", "#f39c12", "#e67e22", "#e74c3c")
              ),
              color = "white",
              fontWeight = "bold")
```

### Resources Needing Improvement (Score < 40)

```{r incomplete-resources}
incomplete_resources <- all_scores %>%
  filter(total_score < 40) %>%
  arrange(total_score) %>%
  select(resourceName, resourceType, total_score, completeness_category) %>%
  mutate(total_score = round(total_score, 1))

if (nrow(incomplete_resources) > 0) {
  colnames(incomplete_resources) <- c("Resource Name", "Type", "Score", "Category")

  datatable(incomplete_resources,
            caption = sprintf("Resources Needing Improvement (N = %d)",
                            nrow(incomplete_resources)),
            options = list(pageLength = 15),
            rownames = FALSE) %>%
    formatStyle(columns = "Category",
                backgroundColor = styleEqual(
                  c("Excellent", "Good", "Fair", "Poor", "Minimal"),
                  c("#27ae60", "#2ecc71", "#f39c12", "#e67e22", "#e74c3c")
                ),
                color = "white",
                fontWeight = "bold")
} else {
  cat("No resources with scores below 40. Excellent!")
}
```

---

## Recommendations

Based on the analysis above, here are key recommendations for improving resource completeness:

1. **Focus on Low-Scoring Components**: Identify which score components (availability, critical info, other info, observations) have the lowest average scores across resource types and prioritize filling those fields.

2. **Resource Type Priorities**: Target resource types with lower median scores for systematic improvement efforts.

3. **Observation Documentation**: Encourage researchers to publish observations with DOIs, as these contribute more points (3 vs 1) to the completeness score.

4. **RRID Registration**: Ensure all resources have registered RRIDs to improve findability and citation.

5. **Vendor/Developer Information**: Complete vendor or developer information for resources to improve availability scores.

---

## Session Information

```{r session-info}
sessionInfo()
```
